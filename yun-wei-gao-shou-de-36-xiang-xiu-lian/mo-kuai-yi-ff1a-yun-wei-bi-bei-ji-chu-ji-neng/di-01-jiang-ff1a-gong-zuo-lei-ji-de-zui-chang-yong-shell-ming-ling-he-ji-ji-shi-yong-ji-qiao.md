# 第01讲：工作累积的最常用 Shell 命令合集及使用技巧

在本课时我们主要讲解 Shell 命令合集，以及对控制台的使用技巧。在正式学习这个课时之前你需要掌握如下三部分的知识内容：

* 需要熟悉掌握 Linux；

* 需要了解一些 Shell 基础，课时中会介绍一些常见的 Shell 命令合集；

* 需要了解 TCP 三次握手原理，这个课时的 Shell 命令合集包含对计算机进行网络分析。

## 控制台使用技巧

首先，我们来学习控制台的使用技巧，学习掌握控制台的使用技巧后可以帮助我们熟练快速地操作控制台，提高工作效率；还可以通过快捷键方式避免大量的命令输入，减少出错产生的概率。

那么都有哪些快捷键供我们使用呢，基于我的运维工作经验给你汇总如下：

### 操作快捷键

* Ctrl + r：可以快速查找历史命令；

* Ctrl + l：可以清理控制台屏幕；

* Ctrl + a \ Ctrl + e：移动光标到命令行首\行尾；

* Ctrl + w \ Ctrl + k：删除光标之前\之后的内容。

### VIM文件编辑快捷键

* 快捷键ZZ：文件保存并退出。

### 进程操作快捷键

* Ctrl + c：强制终止程序的执行；

* Ctrl + z：挂起一个进程；

* Ctrl + d：终端中输入 exit 后回车。

### linux命令中快捷键（top）

* Shift + p：根据 CPU 使用率排序；

* Shift + m：根据内存占用排序。

## Shell 命令合集

熟练掌握相关快捷键后，我们便进入 Shell 命令合集的学习，在这一部分需要你根据课时中所讲的知识在课后进行相关操作的练习，练习过程中希望你可以应用上面所讲的控制台使用技巧。

需要注意的是这里的 Shell 命令合集不是简单的单一命令使用，而是讲解 Shell 命令组合的使用，它们的适用场景虽然平时可能很少用到，但通过本课时的学习你能够在遇到此类场景时能够得心应手，而不必临时查找或根据经验拼凑，同时期望通过这些组合命令的学习后你对对基础命令的理解可以得到进一步的提升。

首先，我们需要对 Shell 命令合集做一个分类。

### 空间分析

* 场景1：磁盘空间不足，需快速定位日志目录；

* 场景2：系统产生很多碎片文件，导致 inode 资源不足。

### 指定文件操作

* 场景1：批量查找文件作内容替换；

* 场景2：批量查找文件作拷贝打包。

### 链接状态分析

* 场景：想了解用户请求所建立的网络连接状态分析。

* IP 信息提取

* 场景：shell 脚本中希望快速提取到本机 IP。

## 空间分析-场景1

## 空间分析-场景2

## 文件操作-场景1

我们通过 find + 路径 的方式查找需要批量修改的指定的文件名，比如命令中的 consumer.xml 文件，查找到文件后通过 find 自带的参数 exec 将结果传递给另外一条命令 sed 来进行下一步命令的处理。



find 命令中，-name 参数指定查找的文件名，-exec 参数将查找到的内容传递给下一个命令去继续执行相关逻辑，sed 命令主要对文件内容进行替换，这里会将 consumer 文件中的 aaaaaa 替换成 bbbbbb，这就是一个批量查找替换的操作。
## 文件操作-场景2

文件操作的第二种场景是我们需要对文件进行批量的打包、拷贝，你可以看到下面这样的一个组合命令：


```
(find . -name "*.txt"|xargs tar -cvf test.tar) && cp -f test.tar /home/.
```



首先我们来看下括号中的部分，括号中包含两条命令，它们使用管道符进行连接，括号外通过"&&"符号与第三条命令进行连接，也就是我们首先需要执行括号中的组合命令，先查找所有 .txt 文件，然后将结果传递给 xargs 命令进行打包，如果打包成功后才将压缩包传递给 cp 命令进行拷贝。

## 网络连接状态分析
对于网络连接状态分析是运维工程师经常需要做的事情，因为我们经常需要了解系统对外提供的网络服务是否正常，并了解它们的连接状态，这时就可以通过如下的命令组合进行操作：


```
netstat -n | awk '/^tcp/ {++S[$NF]} END {for(a in S) print a, S[a]}'
```



我们先来分析下这个命令组合的构成，整体上来说它由两个命令构成，第一个命令是 netstat -n，这个命令负责查看主机上的所有 TCP、UDP 连接信息，而 awk 命令则负责对这些信息进行进一步的处理，awk 后有一个用两个 "斜杠" 括起来的正则表达式，主要用来匹配以 tcp 开头的每一行信息，所以这里的正则表达式起到了一个过滤的作用（只分析tcp的连接），后面则是对信息过滤后进行具体的统计和输出。

## IP信息提取

而另外一个场景就是提取主机上的 IP 信息，这里推荐使用如下的命令组合：


```
ip a|grep "global"|awk'{print $2}'|awk -F/'{print $1}'
```



## 常见问题答疑

最后，分享一下 对Shell 常有的几个疑问。

问题一：Shell 适不适合作多并发任务？

答案：不适合，在 Shell 中一般需要通过 nohup 方式将需要并发执行的命令放入后台，但这样操作存在一些问题，包括：

* 进程的状态不好控制；

* 进程间信息共享一般以文件方式。

等等，所以，我们当需要进行大的自动化工程任务需要作并发任务时，建议选择 Python、Go、PHP 等语言。

问题二：Shell 的远程执行命令方式是什么？

答案：当 Shell 进行远程执行命令时，通常通过 ssh xx@xxx.xxx.xxx.xxx /home/ieson/imoocc.sh 参数的方式，但如果是批量主机任务，建议选择 ansible、saltstack 这样成熟且专业的工具实现。

问题三：Shell 适合用在什么场景中？

答案：Shell 适合用在追求运维高效（非性能高效）要求的简单场景中，如日志切割、进程分析、系统初始化等。

本专栏课中的所有案例配置及源代码，可以课后通过http://www.jesonc.com/jeson/2020/02/07/ywgs36/自己下载，密码为 mukelaoshi。
