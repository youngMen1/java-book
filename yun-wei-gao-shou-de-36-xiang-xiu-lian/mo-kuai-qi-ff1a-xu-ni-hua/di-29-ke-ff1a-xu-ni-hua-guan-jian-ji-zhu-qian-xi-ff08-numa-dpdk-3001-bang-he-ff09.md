# 第29课：虚拟化关键技术浅析（NUMA、dpdk、绑核）

本课时我们来学习虚拟化关键技术。对于虚拟化技术原理的了解有助于我们对虚拟化技术的应用。

## 虚拟化技术演变

我这里列了一张图，把一些常见的虚拟主机技术进行罗列，横坐标是时间轴，纵坐标是具体的一些虚拟化技术名称。

Ciqc1F7Z5pCAI3wpAACnKzGghUk811.png

虚拟化技术里，有 Virtualbox、KVM、 Docker 及各个虚拟技术。结合横坐标轴，我们可以看到在最早期的虚拟主机是使用软件系统层的虚拟化技术实现的，列举的Virtualbox 是在 2000 年前诞生的，它就是基于软件虚拟化技术实现的。

随着对性能的要求越来越高，硬件也逐步承担了一些虚拟化的工作，就诞生了硬件层次的虚拟化，在硬件层次的虚拟化的里程碑中， KVM 就是一个典型的硬件虚拟化实践机制的开源虚拟化技术。

当前离我们现在最近的虚拟化技术是轻量级的虚拟化，如 Docker 或更早期的 LXC，相比纯主机虚拟的方式，容器的虚拟化更加轻量级，易于发布管理和迁移等等，属于现在广为流行的一种虚拟化服务应用。

虚拟化技术的原理是我们这节课重点讲解的。虚拟化中实现的关键技术，我认为通常可以列举出如下：

1.对于资源的虚拟化实现；
2.NUMA 技术；
3.CPU 绑核；
4.资源隔离；
5.虚拟机的热迁移等等。

以上都是在虚拟化技术里我认为非常关键的技术，本课时，我们将摘取其中的一部分内容来为你讲解。通过学习这些内容，可以帮助你加深对虚拟化技术的了解，方便进行虚拟化应用，同时也可以帮助你在面试过程中，更好地应对虚拟化技术上的一些常见的面试问题。对运维技术面试是十分有帮助的。

## 资源虚拟化技术

首先我们来讲解资源虚拟化的实现。常见的虚拟化资源实现，可以分为如下的一些类型：

1.CPU 虚拟化；
2.内存虚拟化；
4.IO 虚拟化；
5.网络虚拟化；
6.磁盘虚拟化；
7.GPU 虚拟化。

每一个虚拟化的实现都有它针对的技术和对应的一些原理，这些需要我们针对性地去了解。其中我认为最重要就是对于计算资源虚拟化，也就是 CPU 的虚拟化了，它可谓是虚拟化的基础。

接下来我们就以 CPU 虚拟化为例来给你进行讲解。

## CPU 虚拟化原理
在 Linux 操作系统里，进程运行级别可以分为用户态和内核态，而对应 CPU 的指令级别则是通过 Ring 级别来进行访问控制的，级别共分 4 层，从 Ring0 到 Ring3，Ring0 是权限级别最大的，Ring3 是权限级别最小的。Ring3 的权限级对应用户态模式，Ring0 对应内核态。当应用程序执行特权指令时，会通过中断或异常来实现用户态到内核态的切换,比如访问磁盘、写文件，那就要通过执行系统调用（函数），执行系统调用的时候，CPU 的运行级别会发生从 ring3 到 ring0 的切换，并跳转到系统调用对应的内核代码位置执行。

CgqCHl7Z5pqASfvmAAGwHYuxx1k074.png

了解这个概念后我们如果在底层系统层再安装虚拟机，那么就是遵循：硬件层-->物理机系统-->虚拟机管理软件VMM-->虚拟主机系统-->虚拟主机应用 这样一个层次关系。那么在虚拟化技术中虚拟机应用所需要执行特权指令该如何切换呢？

## CPU 全虚拟化原理

下面这张图展示了 CPU 虚化早期的全虚拟化原理的实现方式：

CgqCHl7Z5qGAHRbsAAGofogy0rg750.png

可以看到，内核态 Ring0 级别运行一个叫作 VMM 的软件，这个软件主要是用来做特权指令集的翻译。虚拟机系统 OS 在 Ring1，虚拟机上的应用 App 需要执行特权的底层调用指令时，它会先给自己运行的虚拟机的 OS 系统上发送对应的指令。它在执行特权指令时,会触发异常,然后 VMM 捕获这个异常,在异常里面做翻译模拟,返回到 OS。

我们会看到，这种方式对一条指令执行非常烦琐，需要进行多次转发，性能差。早期的虚拟化技术，早期版本 Vmware 、 Virtualbox，它们都是基于软件虚拟化的方式来实现的，随着虚拟化技术发展以及性能瓶颈越来越凸显，有更好的虚拟化的技术产生。

## CPU 半虚拟化原理

更好的技术最早出来一种技术叫半虚拟化技术。所谓半虚拟化技术，你可以看看下面这张图：

Ciqc1F7Z5qiABuNpAAGxNcsS_Ho822.png