# 第18课：典型网络故障：选择长连接 or 短连接，大量 Timewait 的产生时如何处理？

本课时内容主要分为 4 个模块：

* 第 1 个模块中会讲解什么是长连接和短连接。

* 第 2 个模块讲解长连接和短连接应用场景。

* 第 3 个模块结合 Timewait 和 TCP 连接的关系来讲解它们是如何产生的。

* 第 4 个模块会分析 Timewait 对系统性能产生的一些影响，以及应该如何去进行优化。


## 什么是长连接和短连接

我们进入第 1 个模块的学习，什么是长连接和短连接？这里我画了一张图：

Ciqah16X-TaACWjHAARWKvt67Qs928.png

左边是短连接，右边是长连接。我们会看到短连接为每一次的数据传输准备了一个传输通道，比如客户端向服务端要传送数据的时候，它会先建立连接，然后传递数据，最后关闭连接。当要传递第 2 份数据的时候，又要重复这个过程。所以短连接就是在每一次传输数据前，建立一次连接的通道。



长连接则是建立了一条可以连接通道，并一直保持，每一次传输数据时会复用同一条连接通道。

## 建立长连接的前提

了解了长连接&短连接各自的原理后，我们再来讲一讲，如果客户端要跟服务端建立长连接，它的前提是什么？



主要有两个前提，**第 1 个是客户端使用长连接方式请求。第 2 个是服务端需要支持长连接。**



客户端请求做长连接是指，客户端不能主动去断开一条连接，而是要在复用连接数据传输。服务端需要支持长连接是指在长连接的时间周期内不能主动断开连接，并能支持客户端的请求模式。



我们可以来看一下服务端，拿服务端常用的代理服务 Nginx 为例，在 Nginx 里有一个 keepalive 的配置，如果我们把它设置为 0，则表示把长连接关闭，服务端只能支持短连接，如果我们把 keepalive 设置一个较长的时间周期（比如写成 keepalive_timeout 120s），它表示支持两分钟的长连接。

Cgq2xl6X-TaAeLlvAAB2ENLEb-Q379.png
