# 第14课：割接关键思路解析：停服维护、无缝升级如何设计

在上一课时中我们讲解了割接的相关检查项及命令，本课时我们继续讲解割接的关键思路：停服维护和无缝升级时应该如何进行设计。

## 割接与迁移

通过上一课时的学习，想必你已经对网站割接的定义都有一定的了解。在此基础上再讲一讲割接和迁移存在的区别。

Cgq2xl6FmKmAO_CMAAU2syJogr0306.png

也许你认为割接就是迁移，但事实并非如此，我们可以将割接理解为迁移中的一个关键部分，但它并不完全属于迁移。举个例子，我们需要修改程序的配置，或者要做版本的升级，这些情况都需要作割接操作，但并不属于网站的迁移范围。接下来我会在这张图里，选择入口层 Nginx、数据层 MySQL 这两个案例，对割接的关键思路和步骤进行详细介绍。



论割接的过程可以分为两种：停服割接和不停服割接。停服割接是指在割接过程中，所属的业务服务需要停止对外服务，所以会影响业务或客户端的正常访问。 不停服切割是指在切割过程中，所属的业务服务需要几乎完全正常对外服务，很难对客户的访问和数据产生影响，但不是完全不会有影响。



值得注意的是，通常我们接触的大部分场景都会选择停服割接。这是因为不停服割接对整体的方案设计和人员成本要求较高，需要在前期进行大量的细致分析，并且投入人力，才能完成不停服割接。所以在大部分场景中，我们选择在业务低峰期牺牲一部分用户访问来作停服割接，这样我们的投入成本会更加低。



学习本课时你只需要具备两个基础，即 MySQL 的操作基础和对 Nginx 的一些技术了解。

## Nginx 版本平滑升级

说到了停服割接和不停服割接，接下来我拿入口层一个服务 Nginx ，它的平滑升级为例，为你讲解 Nginx 在做版本升级时是如何做到平滑的不停服升级。



要做到这一点，首先我们需要了解 Nginx 是否支持平滑割接，这是一个前提。如果可以那 Nginx 是如何做到平滑割接的呢？根本上我们需要了解 Nginx 里有一个非常重要的指令（nginx reload），即我们更改 Nginx 的配置，或者是重启服务时，会用到的 Nginx 的 reload 指令。那 reload 指令的原理是如何来支持平滑升级的？



首先，我们知道 Nginx 的启动进程总共包含 master 进程和 work 线程，work 线程负责实际处理用户的请求，而 master 进程则起到管理和分配流量的作用。

Cgq2xl6FmKqAJXLOAAIMFmFy9LU520.png


如图所示，当我们把一个版本升级到另外一个版本时，假设老的版本为 A 版本，当我把 Nginx 的版本做完升级（升级为版本 B），通过执行 nginx reload ，此时不会影响 A 版本的所有 master 进程和 work 线程的工作，而直接会在 A 版本的基础上启用 B 版本的 master 进程和 B 版本的 work 线程。



老的这部分流量请求可以继续通过 A 版本来行处理（所以短时间保持存在），新的流量请求则给到了 B 版本的 master 负责。B 版本会把流量给到 B 版本的 work 线程进行处理，当 A 版本所有的原有老的流量处理完以后，A 版本的 master 进程优雅退出，这时候完全过渡给 B 版本。可以看到，通过这样的一种方式，用户的流量能得到平滑的过渡，并不会影响用户的访问。



Nginx reload 这种方式，给了我们进行 Nginx 版本平滑升级提供支持。



如果遇到问题需要进行回滚，在 Nginx 版本做完编译升级之后，Nginx 的启动进程会生成一个 nginx.old 二进制文件（老版本），如果要回滚到老版本，就可以用 nginx.old 来执行 reload，这样就可以用同样的方式把 B 版本回滚到 A 版本的机制下。


