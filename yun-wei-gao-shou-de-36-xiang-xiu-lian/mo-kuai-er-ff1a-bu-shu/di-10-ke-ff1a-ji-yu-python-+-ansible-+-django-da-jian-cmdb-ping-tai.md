# 第10课：基于 Python+Ansible+Django 搭建 CMDB 平台

本课时我们主要讲解如何基于 Python、Django、Ansible 开发一套具备 Devops 理念的自动化任务执行和资产管理(CMDB)系统。

## 工程简介

这个可以实现自动化任务执行和资产管理的系统取名为 Imoocc，它是基于 Python、Django、Ansible 实现的，共有两个版本，一个是 Python 2.7 版本（你可以在这个 GitHub 地址上 https://github.com/iopsgroup/imoocc 直接下载），另外一个是 Python 3.6 版本（你可以在本课时末尾的链接中通过附件下载）。

Imoocc 工程可以做到自动化资产收集和自动化任务执行，资产管理的部分会自动把服务器上所有的系统、硬件信息和宿主机子机关联信息收集起来，并做平台化展示。

然后打通自动化任务执行，客户端通过调用 API 接口的方式对搜集的资产信息对象执行自动化任务，对应关系如图所示。

![](/static/image/CgpOIF5zJpGAOh_3AAETRSBrz8A133.png)

## 自动化资产管理

想要了解自动化资产管理系统，首先需要理解一个概念，什么是运维自动化系统中的资产？我认为它一共分为三种类型：物理资产、虚拟资产和信息资产。

* 物理资产：如我们看得到的机房、机柜、网络设备、硬件服务器等相关硬件模块都属于物理资产。

* 虚拟资产：我们看不见的，但是它实际上又是很重要的个体。比如，我们可以在虚拟机上通过虚拟化的方式虚拟出 KVM、Vmware、Docker 等相关的虚拟化个体。

* 信息资产：所谓信息资产是一些基本标示信息和个体中的属性，比如说服务器上装的系统，系统上运行的服务，以及每个服务器配置的 IP，还有它的登录等相关信息，等等。

运维资产管理系统就是要把所有的这些资产做整体的管理和收集。我们讲到 CMDB 也是 Devops 设计里面最基础的一个环节，可以通过这样的一张图示来形象的衡量资产管理的重要性。

Cgq2xl5zJpGAMNBTAAF2XF3qyck100.png

在企业里面，Devops 功能包括了监控、配置管理、资产弹性、自动化任务等相关功能。这些功能大多依赖于资产管理的功能。所以搜集资产是 Devops 工程设计里面非常重要、非常基础的一个环节。

## 自动化资产搜集

如果资产作到自动化搜集怎么实现呢？接下来我把这个工程的第一个版本及部分代码给你来演示一下。

Cgq2xl5zJpKAXQ3uAAVfaDFT2hc238.png

首先，用 PyCharm 工具打开工程代码，左侧是目录结构，底部是一个 terminal 控制终端，上面是代码内容，如果你了解 PyCharm 就比较清楚了。

我本地已经准备好一个演示环境，因为需要收集资产信息，本地环境的资产除了包括演示的这台主机以外，还包括另外一台单独的装了 VMware 的虚拟机，在虚拟机上还运行了一个 Docker 的容器（这些就是我本地收集的目标资产对象）。
CgpOIF5zJpKAM5HDAARNAa2lrTA683.png

登录到这台虚拟机后，可以发现启动的容器开放了 ssh 端口并进行了端口的映射（22022->22），所以整体的环境是这样的。我通过客户端一台机器去扫描目标资源，由于环境的限制，这里我把这台虚拟机当成了一台物理设备来进行扫描，正常结果中会把这台设备与容器两个对象中相关的资产信息进行整体的扫描，并且会把它们的关系罗列出来。

回到工程代码，我们来具体演示一下：

Cgq2xl5zJpKALeVmAAJNcMymoDg695.png

回到工程代码，首先需要运行一个脚本，把目标资产信息扫描出来。这里通过 Python 直接执行 main.py 文件，就可以开启对局域网的扫描。我们可以看到这个时候，在终端会输出相关的日志及扫描到的信息。

CgpOIF5zJpKALpfAAAKrgiK7cBE082.png

在脚本执行完成以后，我们会看到打印在终端的信息，这里打印出了登录的主机相关信息，我们还可以看到它的 IP 信息和端口信息。这个 ssh 端口就是容器所映射出来的端口，还会看到把相关的主机容器上的主机信息也做了相关的打印，也就是信息收集。




通过这种方式展示还不够清晰，这就需要有一套前台的展示页面，能够非常清晰的展示所收集的系统信息，并且展示它们的关联关系，所以这里我继续演示前台界面是什么效果。


Cgq2xl5zJpOAfJ37AAKKZIal5Ks938.png

使用 Python manage.py runserver 的方式，在本地监听 5555 端口，并把这个服务运行起来。然后打开浏览器，输入 127.0.0.1:5555 端口的 url地址，这时就可以登录后台系统。在后台系统中你可以看到整个界面会展示几类信息：物理设备信息、虚拟设备信息、网络设备信息。

CgpOIF5zJpOALuvRAACLq9bGI6I552.png

我们重点看下物理设备和虚拟设备信息。在物理设备信息栏里会看到这里已经扫描到了一台物理机，它是一台承载 Docker 类型的物理机。

Cgq2xl5zJpOAcCmiAAKjQ3sBmI8075.png

点击子链接会进入新的界面，新界面会展示这台物理设备上的机器相关属性，比如 IP 地址、服务器品牌、操作系统等（备注：你可以看到这里的服务器品牌是 VMware，因为本地资源有限，所以没有物理设备，这里稍微改动了代码，把 VM 当成物理设备来处理，所以这里实际上是一台虚拟机）。

CgpOIF5zJpOAGCFGAALdX5_qU6o957.png

然后，可以看到它的上线状态，类型、连接用户、登录方式等，我们可以点击子链接，这时会跳到一个新的页面，新页面会展示出登录的用户名、密码等信息，登录方式也做了相关信息资产的保存。

Cgq2xl5zJpSAMOZhAAJZ02uIxOg018.png

然后，我们再回到这个页面，这里可以点击宿主机的类型链接，这样会跳到一个新的页面，这里显示内容表示在宿主机上有多少个子的虚拟机。由于这台宿主机运行的容器，点击新的页面就会展示出这台宿主机上面有容器运行，并且还会展示系统版本，以及连接用户的相关信息，我们也可以点击查看。



这就是我的这一套 CMDB 系统中自动化资产收集的效果演示。

## 课程学习重点、基础


接下来，我们具体介绍一下这套系统。首先，本课并不是要手把手的带你来敲一遍代码，而是希望你可以获得一些自动化运维研发的思路和相关经验，并运用在自己的项目中。

1.设计工程逻辑、工程功能及相关思路。

2.运维自动化的技术选型思路。

3.技术栈的实现思路。

了解了这些以后，我们来看一下学习本课时所需要掌握的基础。首先就是需要了解 Python 语言，具备一定的 Python 开发基础；同时，你还要了解 Django 基础，包括它的模型、视图、URL 等；还要掌握一些前端的基础知识，如 Bootstrap、JS、HTML 等，这里对于前端的知识要求并不高，只需要能看懂即可。

## 工程设计理念

接下来，我们来重点讲解工程的设计理念。

一、资产信息采集

工程设计的第一部分是资产信息采集。我在服务端会运行一套脚本，它采用的是主动探测的方式，也就是服务端主动去探测在同一个局域网内部的客户端的资源。扫描方式则通过一些通用的协议，比如我会通过 ICMP 协议去扫描内部的存活设备，通过 ssh 端口协议去登录获取主机上的信息，等等。采用通用协议的好处是开发、运维实现会更加的简单、通用。

二、优势

传统的 CMDB 系统需要手动录入方式，相比手动录入方式，该系统效率得到了提升。另外，对比被动探测的实现方式，采用主动探测方式会更加方便维护和管理，被动探测往往需要在客户端安装 agent，而 agent 的管理维护其实相对比较复杂。

三 、信息展示

第三块内容就是信息展示了。



整体展示顺序

这个工程的信息展示，你可以看到，在左侧的菜单栏里面，我会把整个 Devops 里与工程相关的功能做一个罗列。

CgpOIF5zJpSACdzWAAA33Ac2y-E712.png