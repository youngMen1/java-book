# 第08课：Shell 如何来实现系统初始化

本课时我们开始进入一个新的课程模块（部署），在这部分我将首先讲解 Shell 如何实现系统初始化，通过 Shell 脚本集成 Linux 操作命令对操作系统进行初始化。

## Shell 脚本简介

### Shell 初始化脚本 Jinit 介绍

首先，这里给你演示一个叫作“Jinit”的脚本，它是用 Shell 实现的系统初始化脚本，它实现了 OS 所需的系统参数优化、运维优化、安全优化、自动化任务等多方面的功能。接下来我会登录到刚装好的一台新的主机，在系统上执行演示这个脚本。



首先 cd 到程序代码目录下，在代码目录下有两个脚本，一个是 Jinit.sh，这是操作系统的初始化脚本，也是我们本课时所需要讲解的；另外一个是 autoconfigip.sh，用于自动配置 IP。

我们往往在安装完操作系统以后，IP 地址可能是动态获取或临时的，所以需要把操作系统临时获取的静态 IP 进行一个 IP 地址配置，autoconfigip.sh 就是用来完成这个工作的，Jinit.sh 会调用并执行脚本。



你可以看下执行效果，在执行过程中，首先输出一些命令所操作的记录。执行完之后，重启主机再次登录，这里需要补充一下，因为我的操作系统是 CentOS 7（这个脚本也是为Centos7准备的），如果你的操作系统不是 CentOS 7，需要根据系统差异对脚本内容进行一些修改。



接下来，重新登录主机，因为 Jinit.sh 脚本对 ssh 登录服务端口和登录方式进行了修改，所以需要用新的方式登录这台主机。这里执行 ssh root，新的主机端口改为 9922，我通过 9922 端口登录主机。



这时，旧密码不再能登录主机，所以需要输入重置后的新密码，接下来便可以登录主机了，你应该细心的 发现，登录主机后，展示的终端交互样式和之前有差异，原因是脚本修改了终端交互显示环境。 

## Shell 初始化脚本 Jinit 框架

刚才演示了 Jinit.sh 脚本的执行过程和执行结果，想必你想了解 Jinit.sh 脚本到底做了哪些系统的初始化，具体修改了哪些内容，接下来就给你详细讲解。
Cgq2xl5qC1-AJZ-eAAOMT2A6vD8550.png

首先，我们来看一下 Jinit.sh 脚本的整体结构。如果你了解 Shell 会发现，这是一种最基础的编写方式，Shell 会由上到下，依次执行每一段优化项。如果你想将脚本写得更好，建议你把优化项封装成函数，这样维护性更高。另外你也可以选择优先调用执行顺序.  

## 学习基础

学习这个脚本之前，你需要有一定的 Linux 操作基础，同时需要了解基础的操作系统原理，接下来，给你画了一张思维导图。

CgpOIF5qC1-ATg7VAALizw8mvh4653.png

图中我列出了 Jinit.sh 脚本里面所具体执行的每一项优化内容，从大类来看，共分为三类，分别是优化操作系统性能、提高操作系统安全和便捷化管理。



所谓优化操作系统性能，主要是把不常用的服务关闭，把一些影响系统性能的安全设置忽略掉，比如关闭 Selinux。另外，也需要优化系统的内核参数，还需要优化启动项配置。



关于提高系统安全性，比如用户登录权限、修改登录方式，修改内核的安全机制等相关设置，都可以在操作系统初始化脚本中执行。



最后就是运维相关的便捷化管理，你可以选择优化 yum 设置、设置 history 记录、创建方便的别名、做一些自动化的任务集成。这些都是 Jinit 脚本所包含的功能，接下来我就给你讲解如何优化操作系统性能开始讲起。

## 优化操作系统性能

### 关闭不常用服务

首先，第一部分就是优化操作系统性能，关闭不常用服务。


在这个脚本里面是这样实现的，我会把一些不常用的服务关闭，比如邮件服务、网卡管理服务等平时做运维管理或者应用程序时不需要用的服务。那为什么需要关闭呢？原因很简单，因为不常用的服务长时间运行在操作系统上会对于操作系统的资源是一个占用，另外出于安全性考虑，不常用服务、对外服务，尽可能地将它关闭，以免暴露不需要的服务端口。


基于这些原因，我就通过在 CentOS 7 操作系统中的 systemctl 去管理服务，并且将这些服务在启动项里面进行关闭。

## 关闭 Selinux

另外一个命令就是关闭 Selinux。Selinux是 内核的安全模组，其提供了访问控制安全策略机制，选择关闭 Selinux，对维护管理会更加方便。因为 Selinux 的安全机制实在是太强大了，而一般的场景又不太需要 Selinux 存在，反而会给实际管理服务运行带来很多干扰。

所以在这个脚本里面，一般企业都会直接在启动项里面把操作系统默认开启的 Selinux 关闭，关闭方式你可以看一下：

```
/bin/sed -i 's/SELINUX=permissive/SELINUX=disabled/' /etc/selinux/config

/bin/sed -i 's/SELINUX=enforcing/SELINUX=disabled/'  /etc/selinux/config
```

这是通过 sed 命令去修改文件里面的配置，直接将 Selinux 关闭。

## 优化操作系统内核参数

另外值得注意的就是优化操作系统内核参数。这里重点给你讲解 Timestamps 配置，建议把它设置为 0。为什么呢？因为在部分极少数的场景中可能会导致网络上的抖动或者丢包，这里给你画一张图演示一下：

Cgq2xl5qC1-ABdFAAALgbr--nNA834.png