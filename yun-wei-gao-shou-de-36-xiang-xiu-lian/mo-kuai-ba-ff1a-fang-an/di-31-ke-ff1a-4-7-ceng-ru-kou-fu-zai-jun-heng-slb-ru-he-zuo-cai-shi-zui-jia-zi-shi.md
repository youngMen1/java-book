# 第31课：4、7 层入口负载均衡 SLB 如何作才是最佳姿势

本课时我们来学习 4/7 层入口负载均衡该如何进行设计。

## 负载均衡分类
讲到负载均衡 LB（全称：Load Balance），负载均衡实现了对海量请求、并发连接、数据传送等客户端相关内容均衡，使得这些流量和压力可以分摊到后台多个单元并行处理，这样就可以避免单个后台服务单元处理压力过大，另外也增强了整体服务的可用性。基于负载均衡功能覆盖在OSI 网络模型范围来划分，可以这样进行分类：

类型一：4 层负载均衡，它是基于传输层的底层的负载均衡方案，可以实现 TCP 连接层的会话保持等功能。

类型二：7 层应用层负载均衡，它可以实现更多针对特定协议应用，比如基于 HTTP 的应用负载均衡，就可以实现对 URL 的转发应用、HTTP 请求的处理，session 信息会话保持等。7 层负载均衡更加针对特定的应用协议，如对 HTTP 和 HTTPS 系统负载均衡的服务通常使用 Nginx、Haproxy 等开源 7 层负载均衡服务。

接下来通过对比做下总结，由于 4 层负载均衡更偏向底层能力的转发，所以它的负载性能相对更好，另外因为 4 层负载均衡偏向于底层的实现模式，所以上层的应用协议都是可以基于 4 层负载均衡转发的，所以 4 层负载均衡的应用范围更广。

而 7 层负载均衡服务针对某一类具体协议，在特定支持的应用协议上支持场景更丰富。

通常一个大门户网站企业，这两个类型负载均衡不是单独存在的，而是结合 4 层负载均衡特性和 7 层负载均衡的优势，整体设计一套高可用服务架构，这里以企业入口层负载均衡常用到的 4 层负载均衡 LVS 结合 Nginx + LUA 所实现 7 层负载均衡架构做一个介绍。

## 4/7 层入口负载均衡实现
Ciqc1F7og5SAHDTIAAFdGy6d7gs623.png

如图所示，在这张图中最上面的是 4 层负载均衡，我们可以看到这里有两台 LVS，分别为 Master （主节点）和 Slave（从节点），它们之间 HA 高可用，把 4 层负载均衡放到了最前面，因为它更加偏向底层的处理能力。

我们看到 4 层负载均衡里，实现了对 TCP 连接层的负载均衡功能，黄色的线是基于数据库，比如 MySQL 来进行负载均衡。

图中的另外一边，原理是基于 4 层负载均衡来保障 7 层负载均衡的高可用，这样就可以让 4 层负载均衡把流量在前端进行一次分流均衡，同时也通过 4 层来保障 7 层负载均衡服务本身的高可用。

这里，当用户的 HTTP 请求到了 4 层 LVS，LVS 进行负载均衡进行转发，将请求转发到后台的多组 7 层负载均衡，7 层负载均衡 Nginx + LUA 实现针对应用层的负载均衡即特定能力，比如 URL 地址处理、session 处理、基于用户连接信息的判断、认证、控制等，都可以在 7 层负载均衡中实现。

通过 Nginx 负载均衡最后倒带真实的 HTTP 后端服务单元，整体上基于 4/7 层结合的负载均衡架构。

## 4 层负载均衡原理及优化点
7 层负载均衡 Nginx + LUA 我们已在本课程第一个章节讲解了很多内容，本课时我们主要讲解 4 层负载均衡实现原理及对应的优化点。

围绕 4 层负载均衡我们还是以 LVS （全称：Linux Virtual Server）为例给你做介绍，LVS 4 层负载均衡的实现有 4 大种类。

1.DR：即三角传输；

2.NAT：也就是目的地址改写与转发；

3.TUNNEL：在原有数据包上再封装了一层数据包；

4.FULLNAT：基于 SNAT 和 DNAT 结合对数据包处理实现转发。

![](/static/image/CgqCHl7og6GAN6_JAAEQoa2o41c358.png)

接下来我们分别介绍 4 种模式的实现原理。