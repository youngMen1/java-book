# 第19课：网络故障分析（ping、mtr、traceroute）与抓包分析（tcpdump）诊断

本课时我们来学习：“网络故障分析与抓包分析”，了解一些运维工作所必须要掌握的网络命令（MTR、traceroute 等）的原理和使用，并进行演示。

## 常见网络故障
首先讲一讲常见的网络故障，粗略分为两种：骨干网络故障和内部网络故障。骨干网络故障表示连接多个区域（地区）的高速网络故障（通常是运营商网络），常见的原因有光缆被挖断、网络设备故障等。

另外一块就是内部（IDC、局域）的网络故障，我们需要对内部网络故障的原因进行更加细致和深刻的了解。导致内部网络故障的原因通常有 4 个：
1.网络设备故障（模块、板卡等） ；
2.网络带宽的瓶颈；
3.黑客对内网的一些攻击；
4.配置和网络管理上面出的一些问题。

运维工程师虽然不是专职一线网络技术，但还是需要懂得定位及反馈网络问题。所以我们需要能够定位网络问题，掌握问题所属故障范围（是主机的网络配置问题，还是服务本身的问题，或是某一段路由出现故障等) 。

对于网络故障的诊断，我要给你重点讲解的是 traceroute 和 MTR 命令的使用场景。通常我们在进行网络故障分析时，最常用到就是 ping 命令了。比如我们想要去判断网络对目的端是否可达，就可以通过 ping 命令去发 ICMP 的包，但是这里存在一个问题，如果我们需要去 ping 多台主机或是一个主机段的主机，在操作时，可能就需要有一个命令能够帮批量的 ping 指定的主机段内的主机，这时仅通过 ping 命令是不可行的，这里建议你使用 fping 命令。

另外一种情况是， ping 命令发送的是 ICMP 的协议，而服务端通常有可能因为安全的考虑关闭了 ICMP 协议的请求导致 ping 命令无法得到结果，如果想通过网络数据诊断，我们就可以换成别的协议去进行 ping 检测，这里推荐你使用 TCP 的包去做检测，因为一般服务端都会开放一些 TCP 的公共服务端口，我们可以基于 TCP 的协议去 ping 服务端，而这个时候推荐你使用 tcpping 命令工具来作分析。

这两个命令在前面的内容里我们都有讲过。无论是 fping 还有 tcpping ，它们都可以获取一个点到另外一个点的网络数据延迟情况。但是假如我们想要追踪具体的问题，比如当一个点到另外一个点它的网络不可达时，我们想知道是中间哪一段（路由）出现问题，这个时候需要追踪网络数据包路由途径、查看网络故障节点。但是通过 ping 无法解决这个问题，这个时候就要用到 traceroute 和 MTR 命令了。


## traceroute 和 MTR 命令

traceroute 常被用来检测一个点到目的端的所有路由器，它的原理是：traceroute 默认基于 UDP 协议发送数据包到目的端（默认：UDP 端口大于 30000 的数据包）。所以它首先会发送一个 TTL 值等于 1 的数据包，TTL 值等于 1 代表发送的是第 1 次的数据包，发送给路由器并接受以后，会将 TTL 的值减 1，然后再发一个 ICMP 超时的数据包给客户端。

CgoCgV6esyWAGx1tAAGuPOyHnUo585.png

发起 traceroute 的客户端继续进入第 2 次侦测，客户端会发一个 TTL 为 2 的数据包，这样它就可以经过两个路由，等到等于 0 的时候就是到了第 2 个路由，同样路由 2 再返回一个 ICMP TTL 超时的数据包给到客户端，等最终的目标端收到以后，目的端就不会再发 TTL 超时了，而是会发一个 ICMP 目标端口不可达的响应给到客户端。

这时，只要客户端收到了最后一次目的地址返回的 ICMP 目标不可达的错误请求，就会认为已经把数据包发到了最终目的地址（目标服务器），这样就完成了整个 traceroute 的过程。这就是traceroute 可以做到逐级侦测，并且能拿到每一级路由的地址及延迟状态原理。

刚讲到了 traceroute 默认以 UDP 的方式发送，那么有可能在目的地址，防火墙做了安全限制，这样就会造成客户端向服务端不断地发送 UDP 数据包，但是服务端始终无法返回 ICMP 不可达的错误响应，这样就会造成不一致的循环。

为了避免出现这样的情况，我们可以采取这种方式：客户端改为使用 ICMP 协议去给服务端发送数据包，而不是基于 UDP 的方式。这样到了目标地址的服务端后，由于发送的是 ICMP 协议， ICMP 协议回复会改为" ICMP echo replay" 的数据包给到客户端，这个场景中我们可以通过 traceroute -I 的选项（使用发送 ICMP 的协议数据包来避免这样的问题）。

那么刚刚讲到的这些原理，在真正使用 traceroute 命令的时候，该怎么去做呢？我把我所了解的最常用的一些方式介绍给大家。

## traceroute 命令使用方法

首先，traceroute 命令后面加的是我的目的地址，比如说我这里的 traceroute –n www.jesoncc.com 。

–n 表示不做主机名解析，而直接拿到它的 IP 地址。这是一个最常用的方式，它默认发送的是 UDP 大于30000 端口的数据给到目标地址服务端。

如果想要发送 ICMP 协议该怎么做呢？这个时候就可以用 traceroute -I -n 的方式去发送 ICMP 的数据包。

接下来进入控制台来为你演示一下 traceroute 的命令使用，刚讲到通过加入一个 -n 的参数，可以直接看到 IP 地址，而不去显示主机名和名字字符的名称。所以这里安装完 traceroute 命令后，直接在后面加一个 -n 的选项，后面加目标地址或是域名，我这里加的是 www.jesonc.com，这样从客户端向服务端发起 traceroute 请求后，我们会看到每一级的路由地址，以及每一次发送数据包的过程。还可以看到每到一条路由的一些延迟情况。
CgoCgV6es2GADVtdAAHGVu-elhg712.png

