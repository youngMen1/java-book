# 第32课：浅析多可用区容灾、多活到两地三中心的架构

本课时我们来学习多可用区容灾、多活、两地三中心的高可用架构设计。

学前知识
首先我们来了解一些基础概念：

* 地域，它通常是我们在进行 IDC 规划，业务覆盖的用户范围，以及评估网络质量时需要重点考虑的概念。地域以城市为最小单元命名，如：北京、天津等 。

* 可用区，可以理解为独立机房 IDC，独立的可用区是需要完全具备隔离性的，如风火水电这些基础设施、网络一定要进行物理上的隔离，这样才能保障独立的可用区能够在为业务多活架构提供可靠基础设施保障。

对于多个可用区的设计，由于业务间访问延迟时间上有硬性要求，所以建议两个可用区的选址在保障独立物理环境前提下，举例越近越好。通常同城多可用之间的一个物理距离通常是在 100 公里之内，这样尽量让互访延迟在 2ms 以内。

接下来我们讲一下对于可用区高可用设计模式，通常有如下模式：

* 可用区容灾，可用区容灾是指两个以上的可用区节点，通常是以主备形式存在的，备可用区在正常情况是不对外提供服务的，只在主可用区出现故障以后起到容灾切换的作用。

* 同城多活，它是指同地域多个可用区能够同时服务。这些可用区是要同时对外提供服务的。一个可用区即使出现了故障，其他的可用区也能够整体可用，不影响整体的用户访问，这就是同城多活的结构。

* 两地三中心，它是指在同城双活数据中心的基础上，增加了一个异地灾备数据中心。


CgqCHl7rFF6AB9o4AAD3jaiMYWY086.png


如上图所示，包含了入口层、逻辑层、数据层和基建，入口层主要包含了代理网关和负载均衡；而逻辑层主要是和代码服务相关的内容；数据层主要用于存取数据或文本等相关服务，而基建层是指物理设施和网络设备，都是在进行可用区的高可用方案的时候，需要重点设计的。

在这张图的底部会看到公共组件这一层，这里我罗列了两个服务，一个是 DNS 服务，另外一个是K8s 服务，K8s 作为一个整体 PaaS 平台来提供调度， DNS 主要是提供域名的解析。

回到图中，我们来讲一讲在作高可用设计时候，每一层通常重点需要考虑：

基建层的高可用设计，主要要求是需要独立的基础设施，机房节点之间的网络延迟也是需要重点评估。

逻辑层中我们可能需要重点关注的是应用的状态，尽可能地把这些需要有状态化的数据下放到数据层，逻辑层能够更好地及时进行弹性扩容，来支持容灾的架构。

对于公共组件层，则需要提供平台化的调度支持，比如 K8s，需要支持多可用区的调度，以及 DevOps 流程打通。

入口层里，如 DNS，可能需要从 DNS 解析这一层考虑如何进行流量分配，以及出现故障以后如何进行快速调度策略。

数据层则要求数据一致性和实时性，这通常是在数据库在做多活方案时一个非常大的难题，也是需要企业去花很大的精力去投入的。本课时我们主要围绕公共组件层和数据层，结合入口层的设计方式给你进行介绍。

